# æ¼‚ç§»è‡ªé€‚åº”å¯¹æ¯”å­¦ä¹  - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç”ŸæˆML-1Mé•¿åºåˆ—å­é›†

```bash
cd UR4Rec
python scripts/preprocess_ml1m_subset.py --top_k 1000
```

**è¾“å‡º**:
- `data/ml-1m/subset_ratings.dat` (515,329æ¡äº¤äº’)
- `data/ml-1m/user_mapping.txt` (UserIDæ˜ å°„)

**æ•°æ®ç»Ÿè®¡**:
- ğŸ‘¥ ç”¨æˆ·æ•°: 1000
- ğŸ¬ ç‰©å“æ•°: 3646
- ğŸ“Š å¹³å‡åºåˆ—é•¿åº¦: 515
- ğŸ“ˆ åºåˆ—é•¿åº¦èŒƒå›´: [293, 2314]

---

### 2. è¿è¡ŒåŠŸèƒ½æµ‹è¯•

```bash
cd UR4Rec
python test_drift_adaptive.py
```

**éªŒè¯å†…å®¹**:
- âœ… å¯¹æ¯”å­¦ä¹ æŸå¤±è®¡ç®—
- âœ… è‡ªé€‚åº”æ¸©åº¦è°ƒèŠ‚
- âœ… ä¸­é—´è¡¨ç¤ºè¿”å›
- âœ… å®Œæ•´è®­ç»ƒæµç¨‹

---

### 3. æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

#### ğŸ“Œ æ–°å¢æ–¹æ³•ï¼š`compute_contrastive_loss()`

**ä½ç½®**: `models/ur4rec_v2_moe.py`

```python
contrastive_loss = model.compute_contrastive_loss(
    vis_repr=vis_pos,      # [B, D] è§†è§‰ä¸“å®¶è¡¨ç¤º
    sem_repr=sem_pos,      # [B, D] è¯­ä¹‰ä¸“å®¶è¡¨ç¤º
    surprise_score=surprise_batch,  # [B] æƒŠè®¶åº¦åˆ†æ•°ï¼ˆ0-1ï¼‰
    base_temp=0.07,        # åŸºç¡€æ¸©åº¦
    alpha=0.5              # è‡ªé€‚åº”è°ƒèŠ‚ç³»æ•°
)
```

#### ğŸ“Œ è®­ç»ƒå¾ªç¯æ›´æ–°

**ä½ç½®**: `models/fedmem_client.py` çš„ `train_local_model()`

**å…³é”®æ”¹åŠ¨**:

```python
# 1. è·å–ä¸­é—´è¡¨ç¤º
final_scores, info = self.model(..., return_components=True)
vis_out = info['vis_out']  # [B, N, D]
sem_out = info['sem_out']  # [B, N, D]

# 2. è®¡ç®—æƒŠè®¶åº¦ï¼ˆå…³é”®ï¼šdetachæ¢¯åº¦ï¼‰
rec_loss, _ = self.model.compute_loss(final_scores, labels)
surprise = torch.sigmoid(rec_loss).detach()

# 3. æå–æ­£æ ·æœ¬è¡¨ç¤º
vis_pos = vis_out[:, 0, :]  # [B, D]
sem_pos = sem_out[:, 0, :]  # [B, D]

# 4. è®¡ç®—è‡ªé€‚åº”å¯¹æ¯”æŸå¤±
contrastive_loss = self.model.compute_contrastive_loss(
    vis_repr=vis_pos,
    sem_repr=sem_pos,
    surprise_score=surprise.expand(batch_size)
)

# 5. æ€»æŸå¤±
loss = rec_loss + lambda * contrastive_loss
```

---

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°

### æ¼‚ç§»è‡ªé€‚åº”æ¸©åº¦æœºåˆ¶

| åœºæ™¯ | æ¨èæŸå¤± | Surprise | æ¸©åº¦ | æ•ˆæœ |
|------|---------|----------|------|------|
| ğŸŸ¢ æ­£å¸¸ | ä½ | ~0.0 | 0.07 | ä¸¥æ ¼å¯¹é½ |
| ğŸŸ¡ è½»åº¦æ¼‚ç§» | ä¸­ | ~0.5 | 0.0875 | é€‚åº¦æ”¾æ¾ |
| ğŸ”´ æ˜¾è‘—æ¼‚ç§» | é«˜ | ~1.0 | 0.105 | å¤§å¹…æ”¾æ¾ |

**å…¬å¼**:
```
temperature = base_temp * (1 + alpha * surprise)
```

**ç›´è§‰**:
- ğŸ˜Š æ¨¡å‹è‡ªä¿¡ â†’ ä½æ¸©åº¦ â†’ ä¸¥æ ¼å­¦ä¹ 
- ğŸ˜² æ¨¡å‹æƒŠè®¶ â†’ é«˜æ¸©åº¦ â†’ çµæ´»é€‚åº”

---

## ğŸ“Š å®éªŒé…ç½®å»ºè®®

### ML-1Mé•¿åºåˆ—å®éªŒ

```python
# æ¨¡å‹é…ç½®
model = UR4RecV2MoE(
    num_items=3646,
    sasrec_hidden_dim=256,
    visual_dim=512,
    text_dim=384,
    moe_hidden_dim=256
)

# è®­ç»ƒé…ç½®
client = FedMemClient(
    model=model,
    learning_rate=1e-3,
    batch_size=32,
    contrastive_lambda=0.1,  # å¯¹æ¯”å­¦ä¹ æƒé‡
    memory_capacity=50
)

# è‡ªé€‚åº”å‚æ•°ï¼ˆåœ¨compute_contrastive_lossä¸­ï¼‰
base_temp = 0.07   # åŸºç¡€æ¸©åº¦
alpha = 0.5        # è°ƒèŠ‚ç³»æ•°
```

---

## ğŸ” è¶…å‚æ•°å»ºè®®

| å‚æ•° | æ¨èå€¼ | èŒƒå›´ | è¯´æ˜ |
|------|--------|------|------|
| `base_temp` | 0.07 | [0.05, 0.1] | æ ‡å‡†InfoNCEæ¸©åº¦ |
| `alpha` | 0.5 | [0.3, 0.7] | æ¸©åº¦è°ƒèŠ‚å¹…åº¦ |
| `contrastive_lambda` | 0.1 | [0.05, 0.2] | å¯¹æ¯”æŸå¤±æƒé‡ |

âš ï¸ **æ³¨æ„**:
- `alpha`è¿‡å¤§ â†’ è®­ç»ƒä¸ç¨³å®š
- `alpha`è¿‡å° â†’ è‡ªé€‚åº”æ•ˆæœå¼±

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `scripts/preprocess_ml1m_subset.py` - å­é›†ç”Ÿæˆè„šæœ¬
- âœ… `test_drift_adaptive.py` - åŠŸèƒ½æµ‹è¯•
- âœ… `docs/drift_adaptive_learning.md` - å®Œæ•´æ–‡æ¡£
- âœ… `DRIFT_ADAPTIVE_QUICKSTART.md` - å¿«é€ŸæŒ‡å—ï¼ˆæœ¬æ–‡ä»¶ï¼‰

### ä¿®æ”¹æ–‡ä»¶
- âœ… `models/ur4rec_v2_moe.py` - æ–°å¢`compute_contrastive_loss()`æ–¹æ³•
- âœ… `models/fedmem_client.py` - æ›´æ–°`train_local_model()`è®­ç»ƒå¾ªç¯

### ç”Ÿæˆæ•°æ®
- âœ… `data/ml-1m/subset_ratings.dat` - ML-1Må­é›†
- âœ… `data/ml-1m/user_mapping.txt` - UserIDæ˜ å°„

---

## âœ… éªŒè¯æ¸…å•

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯å®‰è£…ï¼š

```bash
# 1. æ£€æŸ¥å­é›†æ•°æ®
ls -lh UR4Rec/data/ml-1m/subset_ratings.dat

# 2. è¿è¡ŒåŠŸèƒ½æµ‹è¯•
cd UR4Rec && python test_drift_adaptive.py

# 3. æ£€æŸ¥æµ‹è¯•è¾“å‡º
# åº”è¯¥çœ‹åˆ° "âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ‰¾ä¸åˆ°pandasæ¨¡å—

**A**: æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
```bash
source venv/bin/activate
```

### Q2: æŸå¤±å‡ºç°NaN

**A**: æ£€æŸ¥æ¸©åº¦è®¾ç½®
```python
# æ·»åŠ æ•°å€¼ç¨³å®šæ€§
logits = similarity / (adaptive_temp + 1e-8)
```

### Q3: Surpriseå§‹ç»ˆå¾ˆé«˜

**A**: å¯èƒ½æ˜¯æ¨¡å‹æœªå……åˆ†è®­ç»ƒ
- å¢åŠ é¢„è®­ç»ƒè½®æ•°
- é™ä½å­¦ä¹ ç‡
- æ£€æŸ¥æ•°æ®è´¨é‡

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

æŸ¥çœ‹å®Œæ•´æ–‡æ¡£äº†è§£æ›´å¤šç»†èŠ‚ï¼š
- ğŸ“„ [`docs/drift_adaptive_learning.md`](docs/drift_adaptive_learning.md)

---

## ğŸ“ ç†è®ºåŸºç¡€

### ä¸ºä»€ä¹ˆéœ€è¦è‡ªé€‚åº”ï¼Ÿ

**ä¼ ç»Ÿå¯¹æ¯”å­¦ä¹ **ï¼ˆå›ºå®šæ¸©åº¦ï¼‰:
```
L = -log(exp(sim/Ï„) / Î£ exp(sim/Ï„))
Ï„ = 0.07 (å›ºå®š)
```

**æ¼‚ç§»è‡ªé€‚åº”å¯¹æ¯”å­¦ä¹ **ï¼ˆåŠ¨æ€æ¸©åº¦ï¼‰:
```
L = -log(exp(sim/Ï„_adaptive) / Î£ exp(sim/Ï„_adaptive))
Ï„_adaptive = Ï„_base * (1 + Î± * surprise)
```

**ä¼˜åŠ¿**:
- âœ… å…´è¶£ç¨³å®šæ—¶ï¼šä¸¥æ ¼å¯¹é½ï¼Œæå‡æ€§èƒ½
- âœ… å…´è¶£æ¼‚ç§»æ—¶ï¼šæ”¾æ¾çº¦æŸï¼Œå¿«é€Ÿé€‚åº”
- âœ… è‡ªåŠ¨å¹³è¡¡ï¼šæ— éœ€æ‰‹åŠ¨è°ƒæ•´

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

åœ¨ML-1Mé•¿åºåˆ—æ•°æ®ä¸Šï¼š

| æŒ‡æ ‡ | åŸºçº¿ | è‡ªé€‚åº” | æå‡ |
|------|------|--------|------|
| HR@10 | 0.xx | 0.xx | +2-5% |
| NDCG@10 | 0.xx | 0.xx | +2-5% |
| é€‚åº”é€Ÿåº¦ | æ…¢ | å¿« | â¬†ï¸ |
| ç¨³å®šæ€§ | ä¸­ | é«˜ | â¬†ï¸ |

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **è¿è¡Œå®Œæ•´å®éªŒ**:
   ```bash
   # ä½¿ç”¨ML-1Må­é›†è¿›è¡Œè”é‚¦å­¦ä¹ 
   python main_federated.py --dataset ml-1m-subset
   ```

2. **å¯¹æ¯”åŸºçº¿**:
   - æ— å¯¹æ¯”å­¦ä¹ 
   - å›ºå®šæ¸©åº¦å¯¹æ¯”å­¦ä¹ 
   - è‡ªé€‚åº”æ¸©åº¦å¯¹æ¯”å­¦ä¹ ï¼ˆæœ¬æ–¹æ³•ï¼‰

3. **åˆ†æç»“æœ**:
   - è®°å½•å„è½®æ¬¡çš„HR@Kå’ŒNDCG@K
   - å¯è§†åŒ–surpriseåˆ†å¸ƒ
   - ç»Ÿè®¡æ¸©åº¦å˜åŒ–

---

## ğŸ“ æ€»ç»“

âœ… **å·²å®Œæˆ**:
1. ML-1Mé•¿åºåˆ—å­é›†ç”Ÿæˆï¼ˆ1000ç”¨æˆ·ï¼Œ515Käº¤äº’ï¼‰
2. æ¼‚ç§»è‡ªé€‚åº”å¯¹æ¯”å­¦ä¹ å®ç°ï¼ˆè‡ªé€‚åº”æ¸©åº¦æœºåˆ¶ï¼‰
3. è®­ç»ƒå¾ªç¯é›†æˆï¼ˆè‡ªåŠ¨åŒ–å¤„ç†ï¼‰
4. å®Œæ•´æµ‹è¯•éªŒè¯ï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰

ğŸ¯ **æ ¸å¿ƒä¼˜åŠ¿**:
- ğŸ”„ **è‡ªåŠ¨é€‚åº”**: æ— éœ€æ‰‹åŠ¨è°ƒæ•´æ¸©åº¦
- ğŸ“ˆ **æ€§èƒ½æå‡**: é¢„æœŸHR@10æå‡2-5%
- ğŸ›¡ï¸ **ç¨³å®šæ€§å¥½**: é¿å…è¿‡åº¦çµæ´»å¯¼è‡´çš„æ³¢åŠ¨
- ğŸ§  **ç»ˆèº«å­¦ä¹ **: æ”¯æŒé•¿åºåˆ—æŒç»­æ”¹è¿›

ğŸš€ **å®éªŒå°±ç»ª**: ä»£ç å·²å®Œæˆï¼Œå¯ç›´æ¥ç”¨äºML-1Må®éªŒï¼

---

**æœ€åæ›´æ–°**: 2025-12-25
**ç»´æŠ¤è€…**: FedDMMR Team
**é—®é¢˜åé¦ˆ**: è¯·æŸ¥çœ‹ `docs/drift_adaptive_learning.md`
