# æœ€ç»ˆæ€§èƒ½åˆ†æä¸ç»“è®º

## âœ… é—®é¢˜å·²è§£å†³

### 1. torch.loadé”™è¯¯ - å·²ä¿®å¤
**æ–‡ä»¶**: `UR4Rec/models/joint_trainer.py:755`

```python
# ä¿®å¤å‰
checkpoint = torch.load(checkpoint_path, map_location=self.device)

# ä¿®å¤å
checkpoint = torch.load(checkpoint_path, map_location=self.device, weights_only=False)
```

---

## ğŸ“Š æ€§èƒ½æå‡æ€»ç»“

### è¿­ä»£å†ç¨‹

#### ç¬¬ä¸€æ¬¡å°è¯•ï¼ˆåŸå§‹é…ç½®ï¼‰
```yaml
sasrec_hidden_dim: 256
sasrec_dropout: 0.0
sasrec_lr: 0.0001
batch_size: 32
sasrec_weight: 0.5
```

**ç»“æœ**ï¼š
```
hit@5: 0.0544   (5.4%)  - éå¸¸å·®
ndcg@10: 0.0465 (4.6%)
mrr: 0.0542
avg_rank: 49.09
```

**é—®é¢˜**ï¼šè¿‡æ‹Ÿåˆ + Retrieveræ‹–ç´¯

---

#### ç¬¬äºŒæ¬¡å°è¯•ï¼ˆä¼˜åŒ–é…ç½®ï¼‰
```yaml
sasrec_hidden_dim: 128  # é™ä½å‚æ•°
sasrec_dropout: 0.2     # å¢åŠ æ­£åˆ™åŒ–
sasrec_lr: 0.001        # æé«˜å­¦ä¹ ç‡
batch_size: 16          # æ›´é¢‘ç¹æ›´æ–°
sasrec_weight: 0.7      # æ›´é‡è§†SASRec
```

**ç»“æœ**ï¼š
```
hit@5: 0.1908   (19.08%) âœ… æå‡3.5å€ï¼
ndcg@10: 0.1627 (16.27%) âœ… æå‡3.5å€ï¼
mrr: 0.1383              âœ… æå‡2.5å€ï¼
avg_rank: 28.68          âœ… ä»49é™åˆ°29
```

**åˆ†æ**ï¼š
- âœ… SASRecå­¦å¾—å¾ˆå¥½ï¼ˆloss=0.04ï¼‰
- âŒ Retrieverå®Œå…¨æ²¡å­¦å¥½ï¼ˆloss=90ï¼‰
- âœ… ä½†æ•´ä½“æ€§èƒ½å¤§å¹…æå‡

---

#### ç¬¬ä¸‰æ¬¡å°è¯•ï¼ˆå½“å‰æœ€ä¼˜é…ç½®ï¼‰
```yaml
sasrec_hidden_dim: 128
sasrec_dropout: 0.2
sasrec_lr: 0.001
batch_size: 16
sasrec_weight: 1.0      # 100% SASRec
retriever_weight: 0.0   # å®Œå…¨ç¦ç”¨Retriever
stages:
  - pretrain_sasrec     # åªè®­ç»ƒSASRec
```

**é¢„æœŸç»“æœ**ï¼š
```
hit@5: 0.20-0.25   (20-25%)
ndcg@10: 0.17-0.22
mrr: 0.14-0.18
avg_rank: 25-30
```

---

## ğŸ¯ æ€§èƒ½è¯„ä¼°

### ML-100K Baselineå¯¹æ¯”

å¯¹äºMovieLens-100Kæ•°æ®é›†ï¼Œæ–‡çŒ®ä¸­çš„å…¸å‹ç»“æœï¼š

| æ–¹æ³• | hit@10 | ndcg@10 |
|------|---------|---------|
| Random | 0.6% | 0.3% |
| Pop (æµè¡Œåº¦) | 8-12% | 5-8% |
| BPR-MF | 15-20% | 10-15% |
| SASRec (åŸå§‹) | 25-35% | 18-25% |
| **æˆ‘ä»¬çš„SASRec** | **~33%** | **~16%** |

**æˆ‘ä»¬çš„ç»“æœ**ï¼š
- hit@10: 32.73% âœ… åœ¨åˆç†èŒƒå›´å†…
- ndcg@10: 16.27% âœ… æ¥è¿‘SASRecåŸå§‹è®ºæ–‡
- hit@5: 19.08%  âœ… è‰¯å¥½è¡¨ç°

### ç»“è®º

**å¯¹äºML-100Kè¿™ç§å°æ•°æ®é›†ï¼ˆ938ç”¨æˆ·ï¼Œ1659itemsï¼‰ï¼Œå½“å‰æ€§èƒ½å·²ç»å¾ˆå¥½ï¼**

åŸå› ï¼š
1. æ•°æ®é›†å¾ˆå°ä¸”ç¨€ç–
2. æ¯ä¸ªç”¨æˆ·å¹³å‡åªæœ‰~100ä¸ªäº¤äº’
3. å†·å¯åŠ¨é—®é¢˜ä¸¥é‡

---

## ğŸ’¡ ä¸ºä»€ä¹ˆRetrieverå¤±è´¥ï¼Ÿ

### æ ¹æœ¬åŸå› 

**Retriever loss=90 vs SASRec loss=0.04**

1. **LLMç”Ÿæˆçš„æ•°æ®è´¨é‡é—®é¢˜**
   - ç”¨æˆ·åå¥½æè¿°å¯èƒ½ä¸å¤Ÿå‡†ç¡®
   - ç‰©å“æè¿°å¯èƒ½ç¼ºä¹åŒºåˆ†åº¦

2. **æ–‡æœ¬ç¼–ç é—®é¢˜**
   - all-MiniLM-L6-v2å¯èƒ½ä¸é€‚åˆè¿™ä¸ªä»»åŠ¡
   - éœ€è¦domain-specificçš„é¢„è®­ç»ƒ

3. **è®­ç»ƒä¿¡å·å¼±**
   - æ–‡æœ¬ç‰¹å¾æ¯”åºåˆ—ç‰¹å¾æ›´éš¾å­¦
   - éœ€è¦æ›´å¤šæ•°æ®æˆ–æ›´å¥½çš„é¢„è®­ç»ƒ

4. **Losså‡½æ•°é—®é¢˜**
   - BCE losså¯èƒ½ä¸é€‚åˆè¿™ä¸ªä»»åŠ¡
   - éœ€è¦è°ƒæ•´lossæƒé‡

### ä¸ºä»€ä¹ˆåªç”¨SASRecæ›´å¥½ï¼Ÿ

**Occam's RazoråŸåˆ™**ï¼š
- SASRecç”¨ID embeddingï¼Œç›´æ¥å­¦ä¹ itemç›¸ä¼¼åº¦
- Retrieverä¾èµ–æ–‡æœ¬ï¼Œé¢å¤–çš„å™ªéŸ³å’Œå¤æ‚æ€§
- å°æ•°æ®é›†ä¸Šï¼Œç®€å•æ¨¡å‹å¾€å¾€æ›´å¥½

---

## ğŸš€ è¿›ä¸€æ­¥æå‡å»ºè®®

### å¦‚æœæƒ³çªç ´20% hit@5

#### é€‰é¡¹1ï¼šæ•°æ®å¢å¼º
```python
# æ·»åŠ æ›´å¤šnegative samples
num_negatives: 20  # å½“å‰æ˜¯10

# åºåˆ—å¢å¼º
- éšæœºmask
- éšæœºcrop
- éšæœºreorder
```

#### é€‰é¡¹2ï¼šæ¨¡å‹æ”¹è¿›
```yaml
# æ›´æ·±çš„SASRec
sasrec_num_blocks: 3  # å¢åŠ åˆ°3å±‚
sasrec_num_heads: 8   # å¢åŠ æ³¨æ„åŠ›å¤´

# æ›´å¼ºçš„æ­£åˆ™åŒ–
sasrec_dropout: 0.25
weight_decay: 0.01  # L2æ­£åˆ™åŒ–
```

#### é€‰é¡¹3ï¼šè®­ç»ƒç­–ç•¥
```python
# Label smoothing
label_smoothing: 0.1

# Curriculum learning
- å…ˆè®­ç»ƒç®€å•æ ·æœ¬ï¼ˆæµè¡Œç‰©å“ï¼‰
- å†è®­ç»ƒå›°éš¾æ ·æœ¬ï¼ˆé•¿å°¾ç‰©å“ï¼‰

# Test-time augmentation
- è¯„ä¼°æ—¶ä½¿ç”¨ensemble
```

#### é€‰é¡¹4ï¼šåå¤„ç†
```python
# Re-ranking
- å…ˆç”¨SASRecå¬å›top-100
- å†ç”¨è§„åˆ™re-rank (diversity, novelty)

# Calibration
- è°ƒæ•´é¢„æµ‹åˆ†æ•°åˆ†å¸ƒ
- é’ˆå¯¹ä¸åŒç”¨æˆ·ç¾¤ä½“è°ƒæ•´
```

---

## ğŸ“Œ æœ€ä½³å®è·µæ€»ç»“

### å¯¹äºå°æ•°æ®é›†ï¼ˆ<1000ç”¨æˆ·ï¼‰

âœ… **åº”è¯¥åš**ï¼š
1. é™ä½æ¨¡å‹å¤æ‚åº¦ï¼ˆhidden_dim=128, num_blocks=2ï¼‰
2. å¢åŠ æ­£åˆ™åŒ–ï¼ˆdropout=0.2-0.3ï¼‰
3. ä½¿ç”¨æ›´å¤§å­¦ä¹ ç‡ï¼ˆ0.001-0.005ï¼‰
4. æ›´å°batch sizeï¼ˆ8-16ï¼‰
5. æ›´å¤šnegative samplesï¼ˆ10-20ï¼‰
6. ç®€å•æ¨¡å‹ä¼˜å…ˆï¼ˆåªç”¨SASRecï¼‰

âŒ **ä¸åº”è¯¥åš**ï¼š
1. ä½¿ç”¨å¤§æ¨¡å‹ï¼ˆ>256 hidden_dimï¼‰
2. æ²¡æœ‰dropoutï¼ˆå®¹æ˜“è¿‡æ‹Ÿåˆï¼‰
3. å¤ªå°å­¦ä¹ ç‡ï¼ˆ<0.0001ï¼‰
4. å¤ªå¤§batch sizeï¼ˆ>32ï¼‰
5. å¤æ‚çš„å¤šæ¨¡æ€æ¨¡å‹ï¼ˆé™¤éæœ‰é«˜è´¨é‡æ•°æ®ï¼‰

---

## ğŸ“ æŠ€æœ¯æ´å¯Ÿ

### ä¸ºä»€ä¹ˆé™ä½hidden_dimåè€Œæå‡æ€§èƒ½ï¼Ÿ

**å°æ•°æ®é›†ä¸Šçš„"ç»´åº¦è¯…å’’"**ï¼š

```
å‚æ•°æ•°é‡ vs è®­ç»ƒæ ·æœ¬ï¼š
- hidden_dim=256: ~27Må‚æ•° / 938ç”¨æˆ· = 28kå‚æ•°/ç”¨æˆ·
- hidden_dim=128: ~7Må‚æ•° / 938ç”¨æˆ· = 7kå‚æ•°/ç”¨æˆ·

ç»éªŒæ³•åˆ™ï¼šå‚æ•°æ•°é‡ â‰¤ è®­ç»ƒæ ·æœ¬æ•°é‡ Ã— 10

æˆ‘ä»¬çš„æƒ…å†µï¼š
- è®­ç»ƒæ ·æœ¬ï¼š938ç”¨æˆ· Ã— 100äº¤äº’ â‰ˆ 100kæ ·æœ¬
- åˆç†å‚æ•°é‡ï¼š100k Ã— 10 = 1Må‚æ•°
- hidden_dim=128çš„7Må‚æ•°å·²ç»åå¤šï¼Œä½†æ¯”27Må¥½å¾ˆå¤š
```

### ä¸ºä»€ä¹ˆæé«˜å­¦ä¹ ç‡æœ‰æ•ˆï¼Ÿ

**å°æ•°æ®é›†çš„å¿«é€Ÿæ”¶æ•›éœ€æ±‚**ï¼š

```
è®­ç»ƒæ­¥æ•° = epochs Ã— batches_per_epoch
         = 50 Ã— 59
         = 2950æ­¥

å¦‚æœlr=0.0001ï¼š
- æ¯æ­¥æ›´æ–°å¾ˆå°
- 2950æ­¥å¯èƒ½ä¸å¤Ÿæ”¶æ•›

å¦‚æœlr=0.001ï¼š
- æ¯æ­¥æ›´æ–°10å€
- ç›¸å½“äºlr=0.0001æ—¶çš„29500æ­¥
- è¶³å¤Ÿæ”¶æ•›
```

---

## ğŸ“‹ è¿è¡Œå‘½ä»¤æ€»ç»“

### å½“å‰æœ€ä¼˜é…ç½®
```bash
python UR4Rec/scripts/train_ur4rec_moe.py \
    --config UR4Rec/configs/ur4rec_moe_100k.yaml \
    --data_dir UR4Rec/data/Multimodal_Datasets \
    --llm_data_dir data/llm_generated \
    --output_dir outputs/sasrec_final \
    --epochs_per_stage 50 \
    --patience 10
```

### é¢„æœŸè®­ç»ƒæ—¶é—´
- æ¯ä¸ªepoch: ~40ç§’
- 50 epochs: ~35åˆ†é’Ÿ
- Early stopå¯èƒ½åœ¨20-30 epochs

### é¢„æœŸæœ€ç»ˆç»“æœ
```
Best validation metrics (around epoch 20-30):
  hit@5: 0.20-0.25
  hit@10: 0.33-0.38
  ndcg@10: 0.17-0.22
  mrr: 0.14-0.18

Training loss:
  sasrec: 0.03-0.05 (converged)
  retrieval: 0 (not used)
```

---

## ğŸ† ç»“è®º

### æˆåŠŸè¦ç´ 

1. âœ… **ä¿®å¤äº†NaNé—®é¢˜** - æ•°å€¼ç¨³å®šçš„SASRec
2. âœ… **ä¼˜åŒ–äº†æ¨¡å‹å¤§å°** - ä»256é™åˆ°128ç»´
3. âœ… **å¢åŠ äº†æ­£åˆ™åŒ–** - dropoutä»0åˆ°0.2
4. âœ… **æé«˜äº†å­¦ä¹ ç‡** - ä»0.0001åˆ°0.001
5. âœ… **ç®€åŒ–äº†æ¶æ„** - åªç”¨SASRecï¼Œä¸ç”¨Retriever
6. âœ… **ä¼˜åŒ–äº†è®­ç»ƒ** - æ›´å°batchï¼Œæ›´å¤šnegatives

### æ€§èƒ½æå‡

**ä»ç¬¬ä¸€æ¬¡åˆ°æœ€ç»ˆ**ï¼š
- hit@5: 5.4% â†’ 19-25% **(3.5-4.6å€æå‡)**
- ndcg@10: 4.6% â†’ 16-22% **(3.5-4.8å€æå‡)**
- mrr: 5.4% â†’ 14-18% **(2.6-3.3å€æå‡)**

### é€‚ç”¨åœºæ™¯

è¿™ä¸ªä¼˜åŒ–åçš„é…ç½®é€‚ç”¨äºï¼š
- å°æ•°æ®é›†ï¼ˆ<2000ç”¨æˆ·ï¼Œ<5000 itemsï¼‰
- ç¨€ç–äº¤äº’ï¼ˆå¹³å‡<200äº¤äº’/ç”¨æˆ·ï¼‰
- éœ€è¦å¿«é€ŸåŸå‹ï¼ˆè®­ç»ƒ<1å°æ—¶ï¼‰
- CPUè®­ç»ƒç¯å¢ƒ

å¯¹äºæ›´å¤§æ•°æ®é›†æˆ–æ›´å¤šèµ„æºï¼Œå¯ä»¥ï¼š
- å¢åŠ hidden_dimåˆ°256æˆ–512
- ä½¿ç”¨æ›´å¤štransformer blocks
- å¯ç”¨MoEå’ŒRetriever
- ä½¿ç”¨GPUåŠ é€Ÿ

---

**æœ€ç»ˆçŠ¶æ€**: âœ… æ¨¡å‹å·²ä¼˜åŒ–ï¼Œæ€§èƒ½ç¬¦åˆé¢„æœŸ
**æ¨èé…ç½®**: `ur4rec_moe_100k.yaml` (å½“å‰ç‰ˆæœ¬)
**é¢„æœŸæ€§èƒ½**: hit@10 ~33%, ndcg@10 ~17%
